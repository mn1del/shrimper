{% extends 'base.html' %}

{% block content %}
<h1>{{ series.name }}</h1>
<form method="get" class="mb-3">
  <select name="race_id" class="form-select" onchange="this.form.submit()">
    <option value="">Select a race</option>
    {% for race in races %}
      <option value="{{ race.race_id }}" {% if selected_race and selected_race.race_id == race.race_id %}selected{% endif %}>
        {{ race.name }} ({{ race.date }})
      </option>
    {% endfor %}
    <option value="__new__">Create New Race</option>
  </select>
</form>

{% if selected_race %}
<div class="card mb-3">
  <div class="card-body">
    <div class="mb-3">
      <label for="start_time" class="form-label">Start Time</label>
      <input type="text" id="start_time" class="form-control" value="{{ selected_race.start_time }}">
    </div>
    <div class="mb-3">
      <label class="form-label">Number of Finishers</label>
      <input type="text" class="form-control" value="{{ finisher_count }}" readonly>
    </div>
  </div>
</div>

<div class="table-responsive" style="overflow-x: auto;">
  <table class="table table-bordered table-sm align-middle sortable" style="white-space: nowrap;">
    <thead class="table-light">
      <tr>
        <th>Abs Pos</th><th>Hcp Pos</th><th>Sailor</th><th>Boat</th><th>Sail No.</th>
        <th>Initial Hcp (s/hr)</th><th>Finish Time (hh:mm:ss)</th><th>On Course Time (s)</th>
        <th>Hcp Allowance (s)</th><th>Adj Time (hh:mm:ss)</th>
        <th>Full Hcp Change (s/hr)</th><th>Adjusted Hcp Change (s/hr)</th>
        <th>Revised Hcp (s/hr)</th><th>Race Pts (Traditional)</th><th>League Pts (Adjusted)</th>
      </tr>
    </thead>
    <tbody>
    {% for comp in fleet %}
      {% set result = (selected_race.results or {}).get(comp.competitor_id, {}) %}
      <tr>
        <td>{{ result.abs_pos|int if result.abs_pos is defined and result.abs_pos is not none else '' }}</td>
        <td>{{ result.hcp_pos|int if result.hcp_pos is defined and result.hcp_pos is not none else '' }}</td>
        <td>{{ comp.sailor_name }}</td>
        <td>{{ comp.boat_name }}</td>
        <td>{{ comp.sail_no }}</td>
        <td>{{ comp.current_handicap_s_per_hr|round|int if comp.current_handicap_s_per_hr is not none else '' }}</td>
        <td sorttable_customkey="{{ result.finish_time or '' }}"><input type="text" class="form-control form-control-sm" value="{{ result.finish_time or '' }}"></td>
        <td>{{ result.on_course_secs|round|int if result.on_course_secs is defined and result.on_course_secs is not none else '' }}</td>
        <td>{{ result.allowance|round|int if result.allowance is defined and result.allowance is not none else '' }}</td>
        <td>{{ result.adj_time or '' }}</td>
        <td>{{ result.full_delta|round|int if result.full_delta is defined and result.full_delta is not none else '' }}</td>
        <td>{{ result.actual_delta|round|int if result.actual_delta is defined and result.actual_delta is not none else '' }}</td>
        <td>{{ result.revised_hcp|round|int if result.revised_hcp is defined and result.revised_hcp is not none else '' }}</td>
        <td>{{ result.race_pts|round|int if result.race_pts is defined and result.race_pts is not none else '' }}</td>
        <td>{{ result.league_pts|round|int if result.league_pts is defined and result.league_pts is not none else '' }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
<script src="{{ url_for('static', filename='sortable.js') }}"></script>
{% endif %}
{% endblock %}
