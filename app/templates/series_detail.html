{% extends 'base.html' %}

{% block content %}
{% if selected_race %}
<div class="d-flex justify-content-end mb-2">
  <button type="button" class="btn btn-outline-secondary" id="editToggle">ðŸ”’</button>
</div>
<div class="card mb-3">
  <div class="card-body">
    <div class="mb-3">
      <label class="form-label">Series Name</label>
      <input type="text" id="series_name" class="form-control" value="{{ series.name }}" disabled>
    </div>
    <div class="mb-3">
      <label class="form-label">Race Date</label>
      <input type="date" id="race_date" class="form-control" value="{{ selected_race.date }}" disabled>
    </div>
    <div class="mb-3">
      <label for="start_time" class="form-label">Start Time</label>
      <input type="text" id="start_time" class="form-control" value="{{ selected_race.start_time }}" disabled>
    </div>
    <div class="mb-3">
      <div id="finisherCount">{{ finisher_display }}</div>
    </div>
  </div>
</div>
{% else %}
<h1>{{ series.name }}</h1>
<form method="get" class="mb-3">
  <select name="race_id" class="form-select" onchange="this.form.submit()">
    <option value="">Select a race</option>
    {% for race in races %}
      <option value="{{ race.race_id }}">{{ race.name }} ({{ race.date }})</option>
    {% endfor %}
    <option value="__new__">Create New Race</option>
  </select>
</form>
{% endif %}

{% if selected_race %}
<style>
  .race-table-wrapper {
    max-height: 600px; /* roughly 15 rows */
    overflow-y: auto;
  }
  .race-table-wrapper thead th {
    position: sticky;
    top: 0;
    z-index: 1;
    background-color: #f8f9fa;
    white-space: normal;
  }
  .race-table-wrapper tbody td {
    white-space: nowrap;
  }
</style>

<div class="table-responsive race-table-wrapper">
  <table class="table table-bordered table-sm align-middle sortable">
    <thead class="table-light">
      <tr>
        <th style="width: 60px;">Abs Pos</th>
        <th style="width: 60px;" data-default-sort="asc">Hcp Pos</th>
        <th style="width: 150px;">Sailor</th>
        <th style="width: 150px;">Boat</th>
        <th style="width: 80px;">Sail No.</th>
        <th style="width: 110px;">Initial Hcp (s/hr)</th>
        <th style="width: 120px;">Finish Time (hh:mm:ss)</th>
        <th style="width: 110px;">On Course Time (s)</th>
        <th style="width: 110px;">Hcp Allowance (s)</th>
        <th style="width: 120px;">Adj Time (hh:mm:ss)</th>
        <th style="width: 120px;">Full Hcp Change (s/hr)</th>
        <th style="width: 140px;">Adjusted Hcp Change (s/hr)</th>
        <th style="width: 110px;">Revised Hcp (s/hr)</th>
        <th style="width: 90px;">Race Pts (Traditional)</th>
        <th style="width: 100px;">League Pts (Adjusted)</th>
      </tr>
    </thead>
    <tbody>
    {% for comp in fleet %}
      {% set result = (selected_race.results or {}).get(comp.competitor_id, {}) %}
      <tr>
        <td>{{ result.abs_pos|int if result.abs_pos is defined and result.abs_pos is not none else '' }}</td>
        <td>{{ result.hcp_pos|int if result.hcp_pos is defined and result.hcp_pos is not none else '' }}</td>
        <td>{{ comp.sailor_name }}</td>
        <td>{{ comp.boat_name }}</td>
        <td>{{ comp.sail_no }}</td>
        <td>{{ comp.current_handicap_s_per_hr|round|int if comp.current_handicap_s_per_hr is not none else '' }}</td>
        <td sorttable_customkey="{{ result.finish_time or '' }}"><input type="text" class="form-control form-control-sm finish-time" data-cid="{{ comp.competitor_id }}" value="{{ result.finish_time or '' }}" disabled></td>
        <td>{{ result.on_course_secs|round|int if result.on_course_secs is defined and result.on_course_secs is not none else '' }}</td>
        <td>{{ result.allowance|round|int if result.allowance is defined and result.allowance is not none else '' }}</td>
        <td>{{ result.adj_time or '' }}</td>
        <td>{{ result.full_delta|round|int if result.full_delta is defined and result.full_delta is not none else '' }}</td>
        <td>{{ result.actual_delta|round|int if result.actual_delta is defined and result.actual_delta is not none else '' }}</td>
        <td>{{ result.revised_hcp|round|int if result.revised_hcp is defined and result.revised_hcp is not none else '' }}</td>
        <td>{{ result.race_pts|round|int if result.race_pts is defined and result.race_pts is not none else '' }}</td>
        <td>{{ result.league_pts|round|int if result.league_pts is defined and result.league_pts is not none else '' }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
<script src="{{ url_for('static', filename='sortable.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  let locked = true;
  const toggle = document.getElementById('editToggle');
  const seriesName = document.getElementById('series_name');
  const raceDate = document.getElementById('race_date');
  const startTime = document.getElementById('start_time');
  const finishInputs = Array.from(document.querySelectorAll('.finish-time'));
  const finisherDiv = document.getElementById('finisherCount');

  function updateLocked() {
    [seriesName, raceDate, startTime, ...finishInputs].forEach(inp => inp.disabled = locked);
    toggle.textContent = locked ? 'ðŸ”’' : 'ðŸ”“';
  }

  function computeFinishers() {
    const count = finishInputs.filter(inp => inp.value.trim() !== '').length;
    finisherDiv.textContent = `Number of Finishers: ${count}`;
  }

  function saveChanges() {
    const payload = {
      series_id: '{{ series.series_id }}',
      series_name: seriesName.value,
      date: raceDate.value,
      start_time: startTime.value,
      finish_times: finishInputs.map(inp => ({competitor_id: inp.dataset.cid, finish_time: inp.value}))
    };
    fetch('{{ url_for('main.update_race', race_id=selected_race.race_id) }}', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    }).then(r => r.json()).then(data => {
      finisherDiv.textContent = `Number of Finishers: ${data.finisher_count}`;
    });
  }

  toggle.addEventListener('click', () => {
    locked = !locked;
    updateLocked();
  });

  [seriesName, raceDate, startTime, ...finishInputs].forEach(inp => {
    inp.addEventListener('change', () => {
      computeFinishers();
      if (!locked) {
        saveChanges();
      }
    });
    inp.addEventListener('input', computeFinishers);
  });

  computeFinishers();
  updateLocked();
});
</script>
{% endif %}
{% endblock %}
