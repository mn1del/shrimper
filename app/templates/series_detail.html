{% extends 'base.html' %}

{% block content %}
{% if selected_race %}
<div class="d-flex align-items-center mb-3">
  <a href="{{ url_for('main.races') }}">Races</a>
  <select class="form-select w-auto ms-2" onchange="window.location=this.value">
    {% for race in all_races %}
      <option value="{{ url_for('main.race_sheet', race_id=race.race_id) }}" {% if race.race_id == selected_race.race_id %}selected{% endif %}>{{ race.date }} {{ race.start_time or '' }} ({{ race.series_name }})</option>
    {% endfor %}
  </select>
</div>
<div class="d-flex justify-content-end mb-2">
  <button type="button" class="btn btn-success me-2 d-none" id="saveChanges">Save Changes</button>
  <button type="button" class="btn btn-danger me-2 d-none" id="cancelChanges">Cancel Changes</button>
  <button type="button" class="btn btn-outline-secondary" id="editToggle">ðŸ”’</button>
</div>
<div class="card mb-3">
  <div class="card-body">
    <div class="row mb-3">
      <label class="col-md-3 col-form-label">Series</label>
      <div class="col-md-9">
        <select class="form-select" id="series_id" disabled>
          {% for s in series_list %}
            <option value="{{ s.series_id }}" {% if series.series_id == s.series_id %}selected{% endif %}>{{ s.name }}</option>
          {% endfor %}
          <option value="__new__">Create New Series</option>
        </select>
      </div>
    </div>
    <div id="new-series-fields" style="display:none;">
      <div class="row mb-3">
        <label class="col-md-3 col-form-label">Series Name</label>
        <div class="col-md-9">
          <input type="text" id="new_series_name" class="form-control" disabled>
        </div>
      </div>
    </div>
    <div class="row mb-3">
      <label class="col-md-3 col-form-label">Race Date</label>
      <div class="col-md-9">
        <input type="date" id="race_date" class="form-control" value="{{ selected_race.date }}" disabled>
      </div>
    </div>
    <div class="row mb-3">
      <label for="start_time" class="col-md-3 col-form-label">Start Time</label>
      <div class="col-md-9">
        <input type="text" id="start_time" class="form-control" value="{{ selected_race.start_time }}" disabled>
      </div>
    </div>
    <div class="row mb-3">
      <label class="col-md-3 col-form-label">Finishers</label>
      <div class="col-md-9">
        <div id="finisherCount">{{ finisher_display }}</div>
      </div>
    </div>
  </div>
</div>
{% else %}
<h1>{{ series.name }}</h1>
<form method="get" class="mb-3">
  <select name="race_id" class="form-select" onchange="this.form.submit()">
    <option value="">Select a race</option>
    {% for race in races %}
      <option value="{{ race.race_id }}">{{ race.name }} ({{ race.date }})</option>
    {% endfor %}
    <option value="__new__">Create New Race</option>
  </select>
</form>
{% endif %}

{% if selected_race %}
<style>
  .race-table-wrapper {
    max-height: 600px; /* roughly 15 rows */
    overflow-y: auto;
  }
  .race-table-wrapper thead th {
    position: sticky;
    top: 0;
    z-index: 1;
    background-color: #f8f9fa;
    white-space: normal;
  }
  .race-table-wrapper tbody td {
    white-space: nowrap;
  }
  #confirmModal .modal-content {
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  #confirmModal .modal-body {
    overflow-y: auto;
  }
  @media (max-width: 576px) {
    #confirmModal .modal-dialog {
      margin: 0;
      height: 100%;
      display: flex;
      align-items: flex-end;
    }
    #confirmModal.fade .modal-dialog {
      transition: transform .3s ease-out;
      transform: translateY(100%);
    }
    #confirmModal.show .modal-dialog {
      transform: translateY(0);
    }
    #confirmModal .modal-content {
      border-radius: 0;
    }
  }
</style>

<div class="table-responsive race-table-wrapper">
  <table class="table table-bordered table-sm align-middle sortable">
    <thead class="table-light">
      <tr>
        <th style="width: 60px;">Abs Pos</th>
        <th style="width: 60px;" data-default-sort="asc">Hcp Pos</th>
        <th style="width: 150px;">Sailor</th>
        <th style="width: 150px;">Boat</th>
        <th style="width: 80px;">Sail No.</th>
        <th style="width: 110px;">Hcp (s/hr)</th>
        <th style="width: 120px;">Finish Time (hh:mm:ss)</th>
        <th style="width: 110px;">On Course Time (s)</th>
        <th style="width: 110px;">Hcp Allowance (s)</th>
        <th style="width: 120px;">Adj Time (hh:mm:ss)</th>
        <th style="width: 120px;">Full Hcp Change (s/hr)</th>
        <th style="width: 120px;">Fleet Adjustment (%)</th>
        <th style="width: 140px;">Adjusted Hcp Change (s/hr)</th>
        <th style="width: 110px;">Revised Hcp (s/hr)</th>
        <th style="width: 90px;">Race Pts (Traditional)</th>
        <th style="width: 100px;">League Pts (Adjusted)</th>
      </tr>
    </thead>
    <tbody>
    {% for comp in fleet %}
      {% set result = (selected_race.results or {}).get(comp.competitor_id, {}) %}
      <tr>
        <td>{{ result.abs_pos|int if result.abs_pos is defined and result.abs_pos is not none else '' }}</td>
        <td>{{ result.hcp_pos|int if result.hcp_pos is defined and result.hcp_pos is not none else '' }}</td>
        <td>{{ comp.sailor_name }}</td>
        <td>{{ comp.boat_name }}</td>
        <td>{{ comp.sail_no }}</td>
        <td>{{ comp.current_handicap_s_per_hr|round|int if comp.current_handicap_s_per_hr is not none else '' }}</td>
        <td sorttable_customkey="{{ result.finish_time or '' }}"><input type="text" class="form-control form-control-sm finish-time" data-cid="{{ comp.competitor_id }}" data-name="{{ comp.sailor_name }}" value="{{ result.finish_time or '' }}" disabled></td>
        <td>{{ result.on_course_secs|round|int if result.on_course_secs is defined and result.on_course_secs is not none else '' }}</td>
        <td>{{ result.allowance|round|int if result.allowance is defined and result.allowance is not none else '' }}</td>
        <td>{{ result.adj_time or '' }}</td>
        <td>{{ result.full_delta|round|int if result.full_delta is defined and result.full_delta is not none else '' }}</td>
        <td>{{ fleet_adjustment if fleet_adjustment is not none else '' }}</td>
        <td>{{ result.actual_delta|round|int if result.actual_delta is defined and result.actual_delta is not none else '' }}</td>
        <td>{{ result.revised_hcp|round|int if result.revised_hcp is defined and result.revised_hcp is not none else '' }}</td>
        <td>{{ result.race_pts|round|int if result.race_pts is defined and result.race_pts is not none else '' }}</td>
        <td>{{ result.league_pts|round|int if result.league_pts is defined and result.league_pts is not none else '' }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  </div>
  <div class="text-end mt-3">
    <button type="button" class="btn btn-danger d-none" id="deleteRace">Delete Race</button>
  </div>
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">You are about to make the following changes:</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul id="changeList" class="mb-0"></ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmSave">Continue</button>
      </div>
    </div>
  </div>
</div>
<script src="{{ url_for('static', filename='sortable.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  let locked = {{ 'false' if unlocked else 'true' }};
  const toggle = document.getElementById('editToggle');
  const saveBtn = document.getElementById('saveChanges');
  const cancelBtn = document.getElementById('cancelChanges');
  const seriesSelect = document.getElementById('series_id');
  const newSeriesFields = document.getElementById('new-series-fields');
  const newSeriesName = document.getElementById('new_series_name');
  const raceDate = document.getElementById('race_date');
  const startTime = document.getElementById('start_time');
  const finishInputs = Array.from(document.querySelectorAll('.finish-time'));
  const finisherDiv = document.getElementById('finisherCount');
  const confirmModalEl = document.getElementById('confirmModal');
  const confirmModal = new bootstrap.Modal(confirmModalEl);
  const changeList = document.getElementById('changeList');
  const confirmSave = document.getElementById('confirmSave');
  const deleteBtn = document.getElementById('deleteRace');

  let orig = {};
  let pendingAction = null;

  function captureOrig() {
    orig = {
      series_id: seriesSelect.value,
      series_name: seriesSelect.selectedOptions[0]?.text || '',
      new_series_name: newSeriesName.value,
      race_date: raceDate.value,
      start_time: startTime.value,
      finish_times: finishInputs.map(inp => ({cid: inp.dataset.cid, name: inp.dataset.name, value: inp.value}))
    };
  }

  function revertValues() {
    seriesSelect.value = orig.series_id;
    newSeriesName.value = orig.new_series_name;
    raceDate.value = orig.race_date;
    startTime.value = orig.start_time;
    orig.finish_times.forEach(o => {
      const inp = finishInputs.find(i => i.dataset.cid === o.cid);
      if (inp) inp.value = o.value;
    });
    computeFinishers();
    toggleSeries();
  }

  function hasChanges() {
    if (seriesSelect.value !== orig.series_id) return true;
    if (newSeriesName.value !== orig.new_series_name) return true;
    if (raceDate.value !== orig.race_date) return true;
    if (startTime.value !== orig.start_time) return true;
    for (const o of orig.finish_times) {
      const cur = finishInputs.find(i => i.dataset.cid === o.cid);
      if (cur && cur.value !== o.value) return true;
    }
    return false;
  }

  function updateButtons() {
    const dirty = !locked && hasChanges();
    saveBtn.classList.toggle('d-none', !dirty);
    cancelBtn.classList.toggle('d-none', !dirty);
  }

  function toggleSeries() {
    if (seriesSelect.value === '__new__') {
      newSeriesFields.style.display = 'block';
    } else {
      newSeriesFields.style.display = 'none';
    }
  }

  function updateLocked() {
    [seriesSelect, newSeriesName, raceDate, startTime, ...finishInputs].forEach(inp => inp.disabled = locked);
    toggle.textContent = locked ? 'ðŸ”’' : 'ðŸ”“';
    updateButtons();
    deleteBtn.classList.toggle('d-none', locked);
  }

  function computeFinishers() {
    const count = finishInputs.filter(inp => inp.value.trim() !== '').length;
    finisherDiv.textContent = `Number of Finishers: ${count}`;
  }

  function listChanges() {
    const changes = [];
    if (seriesSelect.value !== orig.series_id) {
      changes.push(`Series: "${orig.series_name}" â†’ "${seriesSelect.selectedOptions[0].text}"`);
    }
    if (newSeriesName.value !== orig.new_series_name) {
      changes.push(`New Series Name: "${orig.new_series_name}" â†’ "${newSeriesName.value}"`);
    }
    if (raceDate.value !== orig.race_date) {
      changes.push(`Race Date: "${orig.race_date}" â†’ "${raceDate.value}"`);
    }
    if (startTime.value !== orig.start_time) {
      changes.push(`Start Time: "${orig.start_time}" â†’ "${startTime.value}"`);
    }
    orig.finish_times.forEach(o => {
      const cur = finishInputs.find(i => i.dataset.cid === o.cid);
      if (cur && cur.value !== o.value) {
        changes.push(`${o.name} finish time: "${o.value}" â†’ "${cur.value}"`);
      }
    });
    return changes;
  }

  function saveChanges() {
    const payload = {
      series_id: seriesSelect.value,
      new_series_name: newSeriesName.value,
      date: raceDate.value,
      start_time: startTime.value,
      finish_times: finishInputs.map(inp => ({competitor_id: inp.dataset.cid, finish_time: inp.value}))
    };
    return fetch('{{ url_for('main.update_race', race_id=selected_race.race_id) }}', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    }).then(r => r.json()).then(data => {
      finisherDiv.textContent = `Number of Finishers: ${data.finisher_count}`;
      if (data.redirect) {
        window.location = data.redirect;
      }
    });
  }

  toggle.addEventListener('click', () => {
    locked = !locked;
    if (!locked) {
      captureOrig();
    }
    updateLocked();
  });

  [seriesSelect, newSeriesName, raceDate, startTime, ...finishInputs].forEach(inp => {
    inp.addEventListener('change', () => {
      computeFinishers();
      toggleSeries();
      updateButtons();
    });
  });

  finishInputs.forEach(inp => inp.addEventListener('input', () => {
    computeFinishers();
    updateButtons();
  }));

  cancelBtn.addEventListener('click', () => {
    revertValues();
    locked = true;
    updateLocked();
  });

  saveBtn.addEventListener('click', () => {
    const changes = listChanges();
    changeList.innerHTML = '';
    changes.forEach(ch => {
      const li = document.createElement('li');
      li.textContent = ch;
      changeList.appendChild(li);
    });
    pendingAction = 'save';
    confirmModal.show();
  });

  confirmSave.addEventListener('click', () => {
    if (pendingAction === 'delete') {
      deleteRace().then(data => {
        if (data.redirect) {
          window.location = data.redirect;
        }
      });
    } else {
      saveChanges().then(() => {
        captureOrig();
        locked = true;
        updateLocked();
      });
    }
    confirmModal.hide();
  });

  deleteBtn.addEventListener('click', () => {
    changeList.innerHTML = '';
    const li = document.createElement('li');
    li.textContent = 'This race will be permanently deleted.';
    changeList.appendChild(li);
    pendingAction = 'delete';
    confirmModal.show();
  });

  function deleteRace() {
    return fetch('{{ url_for('main.delete_race', race_id=selected_race.race_id) }}', {
      method: 'DELETE'
    }).then(r => r.json());
  }

  computeFinishers();
  toggleSeries();
  captureOrig();
  updateLocked();
});
</script>
{% endif %}
{% endblock %}
