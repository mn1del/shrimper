{% extends 'base.html' %}

{% block content %}
<h1>Standings</h1>
<form method="get" class="row g-3 mb-3">
  <div class="col-auto">
    <label class="form-label" for="season">Season</label>
    <select name="season" id="season" class="form-select" onchange="this.form.submit()">
      {% for s in seasons %}
      <option value="{{ s }}" {% if s == selected_season %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <label class="form-label" for="format">Scoring format</label>
    <select name="format" id="format" class="form-select" onchange="this.form.submit()">
      <option value="league" {% if scoring_format == 'league' %}selected{% endif %}>League</option>
      <option value="traditional" {% if scoring_format == 'traditional' %}selected{% endif %}>Traditional</option>
    </select>
  </div>
</form>
{% set ns = namespace(count=0) %}
{% for g in race_groups %}
  {% set ns.count = ns.count + (g.races|length) %}
{% endfor %}
{% set colour_classes = ['bg-primary-subtle','bg-secondary-subtle','bg-success-subtle','bg-info-subtle','bg-warning-subtle','bg-danger-subtle'] %}

<style>
  .series-boundary {
    border-left: 2px solid var(--bs-border-color);
  }
  .series-group {
    cursor: pointer;
  }
  .rotate-90 {
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    white-space: nowrap;
    text-align: center;
  }
  .standings-table thead tr:nth-child(2) th:not(.series-group),
  .standings-table thead tr:nth-child(3) th,
  .standings-table tbody td {
    width: 65px;
    min-width: 65px;
    max-width: 65px;
  }
  .standings-table th.sailor-col,
  .standings-table td.sailor-col,
  .standings-table th.boat-col,
  .standings-table td.boat-col {
    width: 175px;
    min-width: 175px;
    max-width: 175px;
  }
  .standings-table thead tr:first-child th {
    position: sticky;
    top: 0;
    background: var(--bs-body-bg);
    z-index: 3;
  }
  .standings-table thead tr:nth-child(2) th {
    position: sticky;
    top: 2.5rem;
    background: var(--bs-body-bg);
    z-index: 2;
  }
  .standings-table thead tr:nth-child(3) th {
    position: sticky;
    top: 5rem;
    background: var(--bs-body-bg);
    z-index: 2;
    vertical-align: middle;
  }
  .standings-table thead tr:nth-child(2) th:first-child,
  .standings-table tbody td:first-child {
    position: sticky;
    left: 0;
    background: var(--bs-body-bg);
    z-index: 1;
  }
  .standings-table thead tr:nth-child(2) th:first-child {
    z-index: 4;
  }
</style>

<div class="table-responsive">
  <table class="table table-striped table-sm standings-table">
    <thead>
      <tr>
        <th colspan="6"></th>
        <th colspan="{{ ns.count + (race_groups|length) * (2 if scoring_format == 'traditional' else 1) }}" class="text-center">Series results (click to see individual race scores):</th>
      </tr>
      <tr>
        <th rowspan="2">Position</th>
        <th rowspan="2" class="sailor-col">Sailor</th>
        <th rowspan="2" class="boat-col">Boat</th>
        <th rowspan="2">Sail No.</th>
        <th rowspan="2"># Races</th>
        <th rowspan="2" class="fw-bold">Total Points</th>
        {% for group in race_groups %}
        {% set idx = loop.index0 %}
        {% set colour_class = colour_classes[idx % (colour_classes|length)] %}
        <th class="text-center series-group {{ colour_class }}{% if not loop.first %} series-boundary{% endif %}" data-series="{{ idx }}" colspan="{{ 2 if scoring_format == 'traditional' else 1 }}">{{ group.series_name }}</th>
        {% endfor %}
      </tr>
      <tr>
        {% for group in race_groups %}
          {% set idx = loop.index0 %}
          {% set colour_class = colour_classes[idx % (colour_classes|length)] %}
          {% for race in group.races %}
          <th class="series-{{ idx }} {{ colour_class }}{% if loop.index0 == 0 and idx > 0 %} series-boundary{% endif %} d-none rotate-90 text-center align-middle">
            <a href="{{ url_for('main.series_detail', series_id=group.series_id, race_id=race.race_id) }}" class="d-block text-decoration-none text-reset">{{ race.date }} {{ race.start_time[:5] if race.start_time }}</a>
          </th>
          {% endfor %}
          {% if scoring_format == 'traditional' %}
          <th class="count-{{ idx }} {{ colour_class }}{% if idx > 0 %} series-boundary{% endif %}"># Races</th>
          <th class="{{ colour_class }}">Total</th>
          {% else %}
          <th class="{{ colour_class }}{% if idx > 0 %} series-boundary{% endif %}">Total</th>
          {% endif %}
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in standings %}
      <tr>
        <td>{{ row.position }}</td>
        <td class="sailor-col">{{ row.sailor }}</td>
        <td class="boat-col">{{ row.boat }}</td>
        <td>{{ row.sail_number }}</td>
        <td>{{ row.race_count }}</td>
        <td class="fw-bold">{{ '%.1f'|format(row.total_points) }}</td>
        {% for group in race_groups %}
          {% set idx = loop.index0 %}
          {% set colour_class = colour_classes[idx % (colour_classes|length)] %}
          {% for race in group.races %}
            {% set pts = row.race_points.get(race.race_id) %}
            {% set dropped = scoring_format == 'traditional' and (row.dropped_races and race.race_id in row.dropped_races) %}
            {% set finished = row.race_finished.get(race.race_id, False) %}
            {% set classes = 'series-' ~ idx ~ ' d-none' %}
            {% if loop.index0 == 0 and idx > 0 %}{% set classes = classes + ' series-boundary' %}{% endif %}
            {% if dropped %}{% set classes = classes + ' text-danger' %}{% elif not finished %}{% set classes = classes + ' text-muted' %}{% endif %}
            <td class="{{ classes }}">
              <a href="{{ url_for('main.series_detail', series_id=group.series_id, race_id=race.race_id) }}" class="d-block text-decoration-none text-reset">{% if pts is not none %}{{ '%.1f'|format(pts) }}{% else %}&nbsp;{% endif %}</a>
            </td>
          {% endfor %}
          {% if scoring_format == 'traditional' %}
          <td class="count-{{ idx }} {{ colour_class }}{% if idx > 0 %} series-boundary{% endif %}">{{ row.series_counts.get(idx, 0) }}</td>
          {% set total = row.series_totals.get(idx) %}
          <td class="{{ colour_class }}">{% if total is not none %}{{ '%.1f'|format(total) }}{% else %}&nbsp;{% endif %}</td>
          {% else %}
          {% set total = row.series_totals.get(idx) %}
          <td class="{{ colour_class }}{% if idx > 0 %} series-boundary{% endif %}">{% if total is not none %}{{ '%.1f'|format(total) }}{% else %}&nbsp;{% endif %}</td>
          {% endif %}
        {% endfor %}
      </tr>
      {% else %}
      <tr><td colspan="{{ 6 + ns.count + (race_groups|length) * (2 if scoring_format == 'traditional' else 1) }}" class="text-muted">No data.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<script>
  const extraCols = {{ 2 if scoring_format == 'traditional' else 1 }};
  document.querySelectorAll('.series-group').forEach(header => {
    header.addEventListener('click', () => {
      const idx = header.dataset.series;
      const raceHeaders = document.querySelectorAll('th.series-' + idx);
      const raceCells = document.querySelectorAll('td.series-' + idx);
      const countHeader = document.querySelector('th.count-' + idx);
      const countCells = document.querySelectorAll('td.count-' + idx);
      const hidden = raceHeaders.length && raceHeaders[0].classList.contains('d-none');
      raceHeaders.forEach(el => el.classList.toggle('d-none', !hidden));
      raceCells.forEach(el => el.classList.toggle('d-none', !hidden));
      if (countHeader) {
        countHeader.classList.toggle('series-boundary', !hidden);
      }
      countCells.forEach(el => el.classList.toggle('series-boundary', !hidden));
      header.colSpan = hidden ? raceHeaders.length + extraCols : extraCols;
    });
  });
</script>
{% endblock %}
