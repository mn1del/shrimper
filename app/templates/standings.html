{% extends 'base.html' %}

{% block content %}
<h1>Standings</h1>
<form method="get" class="row g-3 mb-3">
  <div class="col-auto">
    <label class="form-label" for="season">Season</label>
    <select name="season" id="season" class="form-select" onchange="this.form.submit()">
      {% for s in seasons %}
      <option value="{{ s }}" {% if s == selected_season %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <label class="form-label" for="format">Scoring format</label>
    <select name="format" id="format" class="form-select" onchange="this.form.submit()">
      <option value="league" {% if scoring_format == 'league' %}selected{% endif %}>League</option>
      <option value="traditional" {% if scoring_format == 'traditional' %}selected{% endif %}>Traditional</option>
    </select>
  </div>
</form>
<div class="table-responsive">
  <table class="table table-striped table-sm">
    {% set ns = namespace(count=0) %}
    {% for g in race_groups %}
      {% set ns.count = ns.count + (g.races|length) %}
    {% endfor %}
    <thead>
      <tr>
        <th rowspan="2">Position</th>
        <th rowspan="2">Sailor</th>
        <th rowspan="2">Boat</th>
        <th rowspan="2">Sail No.</th>
        <th rowspan="2"># Races</th>
        {% for group in race_groups %}
        {% set idx = loop.index0 %}
        <th class="text-center" colspan="{{ group.races|length }}">
          <button type="button" class="btn btn-link p-0 series-toggle" data-series="{{ idx }}">{{ group.series_name }}</button>
        </th>
        {% endfor %}
        <th rowspan="2">Total Points</th>
      </tr>
      <tr>
        {% for group in race_groups %}
          {% set idx = loop.index0 %}
          {% for race in group.races %}
          <th class="series-{{ idx }}">{{ race.date }} {{ race.start_time }}</th>
          {% endfor %}
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in standings %}
      <tr>
        <td>{{ row.position }}</td>
        <td>{{ row.sailor }}</td>
        <td>{{ row.boat }}</td>
        <td>{{ row.sail_number }}</td>
        <td>{{ row.race_count }}</td>
        {% for group in race_groups %}
          {% set idx = loop.index0 %}
          {% for race in group.races %}
            {% set pts = row.race_points.get(race.race_id) %}
            <td class="series-{{ idx }}">{% if pts is not none %}{{ '%.1f'|format(pts) }}{% else %}&nbsp;{% endif %}</td>
          {% endfor %}
        {% endfor %}
        <td>{{ '%.1f'|format(row.total_points) }}</td>
      </tr>
      {% else %}
      <tr><td colspan="{{ 6 + ns.count }}" class="text-muted">No data.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<script>
  document.querySelectorAll('.series-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const idx = btn.dataset.series;
      document.querySelectorAll('.series-' + idx).forEach(el => {
        el.classList.toggle('d-none');
      });
    });
  });
</script>
{% endblock %}
