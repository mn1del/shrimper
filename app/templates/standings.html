{% extends 'base.html' %}

{% block content %}
<h1>Standings</h1>
<form method="get" class="row g-3 mb-3">
  <div class="col-auto">
    <label class="form-label" for="season">Season</label>
    <select name="season" id="season" class="form-select" onchange="this.form.submit()">
      {% for s in seasons %}
      <option value="{{ s }}" {% if s == selected_season %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <label class="form-label" for="format">Scoring format</label>
    <select name="format" id="format" class="form-select" onchange="this.form.submit()">
      <option value="league" {% if scoring_format == 'league' %}selected{% endif %}>League</option>
      <option value="traditional" {% if scoring_format == 'traditional' %}selected{% endif %}>Traditional</option>
    </select>
  </div>
</form>
{% set ns = namespace(count=0) %}
{% for g in race_groups %}
  {% set ns.count = ns.count + (g.races|length) %}
{% endfor %}
{% set colour_classes = ['bg-primary-subtle','bg-secondary-subtle','bg-success-subtle','bg-info-subtle','bg-warning-subtle','bg-danger-subtle'] %}

<style>
  .series-boundary {
    border-left: 2px solid var(--bs-border-color);
  }
</style>

<div class="mb-2">
  {% for group in race_groups %}
    {% set idx = loop.index0 %}
    {% set colour_class = colour_classes[idx % (colour_classes|length)] %}
    <div class="form-check form-check-inline">
      <input class="form-check-input series-toggle" type="checkbox" id="seriesToggle{{ idx }}" data-series="{{ idx }}" checked>
      <label class="form-check-label {{ colour_class }} px-1 rounded" for="seriesToggle{{ idx }}">{{ group.series_name }}</label>
    </div>
  {% endfor %}
</div>

<div class="table-responsive">
  <table class="table table-striped table-sm">
    <thead>
      <tr>
        <th rowspan="2">Position</th>
        <th rowspan="2">Sailor</th>
        <th rowspan="2">Boat</th>
        <th rowspan="2">Sail No.</th>
        <th rowspan="2"># Races</th>
        {% for group in race_groups %}
        {% set idx = loop.index0 %}
        {% set colour_class = colour_classes[idx % (colour_classes|length)] %}
        <th class="text-center series-group {{ colour_class }}{% if not loop.first %} series-boundary{% endif %}" colspan="{{ group.races|length + 1 }}">{{ group.series_name }}</th>
        {% endfor %}
        <th rowspan="2" class="fw-bold">Total Points</th>
      </tr>
      <tr>
        {% for group in race_groups %}
          {% set idx = loop.index0 %}
          {% set colour_class = colour_classes[idx % (colour_classes|length)] %}
          {% for race in group.races %}
          <th class="series-{{ idx }} {{ colour_class }}{% if loop.index0 == 0 and idx > 0 %} series-boundary{% endif %}">{{ race.date }} {{ race.start_time[:5] if race.start_time }}</th>
          {% endfor %}
          <th class="{{ colour_class }}{% if idx > 0 %} series-boundary{% endif %}">Total</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in standings %}
      <tr>
        <td>{{ row.position }}</td>
        <td>{{ row.sailor }}</td>
        <td>{{ row.boat }}</td>
        <td>{{ row.sail_number }}</td>
        <td>{{ row.race_count }}</td>
        {% for group in race_groups %}
          {% set idx = loop.index0 %}
          {% set colour_class = colour_classes[idx % (colour_classes|length)] %}
          {% for race in group.races %}
            {% set pts = row.race_points.get(race.race_id) %}
            <td class="series-{{ idx }}{% if loop.index0 == 0 and idx > 0 %} series-boundary{% endif %}">{% if pts is not none %}{{ '%.1f'|format(pts) }}{% else %}&nbsp;{% endif %}</td>
          {% endfor %}
          {% set total = row.series_totals.get(idx) %}
          <td class="{{ colour_class }}{% if idx > 0 %} series-boundary{% endif %}">{% if total is not none %}{{ '%.1f'|format(total) }}{% else %}&nbsp;{% endif %}</td>
        {% endfor %}
        <td class="fw-bold">{{ '%.1f'|format(row.total_points) }}</td>
      </tr>
      {% else %}
      <tr><td colspan="{{ 6 + ns.count + (race_groups|length) }}" class="text-muted">No data.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<script>
  document.querySelectorAll('.series-toggle').forEach(cb => {
    cb.addEventListener('change', () => {
      const idx = cb.dataset.series;
      document.querySelectorAll('.series-' + idx).forEach(el => {
        el.classList.toggle('d-none', !cb.checked);
      });
    });
  });
</script>
{% endblock %}
