{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center">
  <h1>Settings</h1>
  <button type="button" class="btn btn-outline-secondary" id="editToggle">ðŸ”’</button>
</div>
<form id="settingsForm">
  <div class="row g-4">
    <div class="col-lg-4">
      <h2 class="h5">Base Handicap Change by Rank</h2>
      <table id="handicapTable" class="table table-sm table-bordered">
        <thead>
          <tr><th>Rank</th><th>Î” (s/hr)</th><th class="edit-only d-none"></th></tr>
        </thead>
        <tbody>
          {% for item in settings.handicap_delta_by_rank %}
          <tr>
            <td><input class="form-control form-control-sm" value="{{ item.rank }}" disabled></td>
            <td><input class="form-control form-control-sm" value="{{ item.delta_s_per_hr }}" disabled></td>
            <td class="edit-only d-none"><button type="button" class="btn btn-sm btn-danger remove-row">&times;</button></td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="edit-only d-none"><tr><td colspan="3"><button type="button" class="btn btn-sm btn-secondary add-row">Add row</button></td></tr></tfoot>
      </table>
    </div>
    <div class="col-lg-4">
      <h2 class="h5">League Points by Rank</h2>
      <table id="leagueTable" class="table table-sm table-bordered">
        <thead>
          <tr><th>Rank</th><th>Points</th><th class="edit-only d-none"></th></tr>
        </thead>
        <tbody>
          {% for item in settings.league_points_by_rank %}
          <tr>
            <td><input class="form-control form-control-sm" value="{{ item.rank }}" disabled></td>
            <td><input class="form-control form-control-sm" value="{{ item.points }}" disabled></td>
            <td class="edit-only d-none"><button type="button" class="btn btn-sm btn-danger remove-row">&times;</button></td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="edit-only d-none"><tr><td colspan="3"><button type="button" class="btn btn-sm btn-secondary add-row">Add row</button></td></tr></tfoot>
      </table>
    </div>
    <div class="col-lg-4">
      <h2 class="h5">Fleet-size Scaling</h2>
      <table id="fleetTable" class="table table-sm table-bordered">
        <thead>
          <tr><th>Finishers</th><th>Factor</th><th class="edit-only d-none"></th></tr>
        </thead>
        <tbody>
          {% for item in settings.fleet_size_factor %}
          <tr>
            <td><input class="form-control form-control-sm" value="{{ item.finishers }}" disabled></td>
            <td><input class="form-control form-control-sm" value="{{ item.factor }}" disabled></td>
            <td class="edit-only d-none"><button type="button" class="btn btn-sm btn-danger remove-row">&times;</button></td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot class="edit-only d-none"><tr><td colspan="3"><button type="button" class="btn btn-sm btn-secondary add-row">Add row</button></td></tr></tfoot>
      </table>
    </div>
  </div>
  <div class="mt-3">
    <button id="saveSettingsBtn" class="btn btn-primary" disabled>Save settings</button>
  </div>
</form>
<script>
document.addEventListener('DOMContentLoaded', () => {
  let locked = true;
  const toggle = document.getElementById('editToggle');
  const saveBtn = document.getElementById('saveSettingsBtn');

  function updateLocked() {
    document.querySelectorAll('#settingsForm input').forEach(inp => inp.disabled = locked);
    document.querySelectorAll('.edit-only').forEach(el => el.classList.toggle('d-none', locked));
    toggle.textContent = locked ? 'ðŸ”’' : 'ðŸ”“';
    saveBtn.disabled = locked;
  }

  toggle.addEventListener('click', () => {
    locked = !locked;
    updateLocked();
  });

  function attachRemove(btn) {
    btn.addEventListener('click', () => {
      btn.closest('tr').remove();
    });
  }

  document.querySelectorAll('.remove-row').forEach(attachRemove);

  document.querySelectorAll('.add-row').forEach(btn => {
    btn.addEventListener('click', () => {
      const table = btn.closest('table');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="form-control form-control-sm"></td>
        <td><input class="form-control form-control-sm"></td>
        <td class="edit-only"><button type="button" class="btn btn-sm btn-danger remove-row">&times;</button></td>
      `;
      table.querySelector('tbody').appendChild(tr);
      attachRemove(tr.querySelector('.remove-row'));
      updateLocked();
    });
  });

  function toValue(str) {
    if (str === '') return null;
    const num = Number(str);
    return isNaN(num) ? str : num;
  }

  function parseTable(table, keys) {
    const rows = [];
    table.querySelectorAll('tbody tr').forEach(tr => {
      const inputs = tr.querySelectorAll('input');
      const first = toValue(inputs[0].value.trim());
      const second = toValue(inputs[1].value.trim());
      if (first !== null && second !== null) {
        const obj = {};
        obj[keys[0]] = first;
        obj[keys[1]] = second;
        rows.push(obj);
      }
    });
    return rows;
  }

  saveBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    const payload = {
      handicap_delta_by_rank: parseTable(document.getElementById('handicapTable'), ['rank', 'delta_s_per_hr']),
      league_points_by_rank: parseTable(document.getElementById('leagueTable'), ['rank', 'points']),
      fleet_size_factor: parseTable(document.getElementById('fleetTable'), ['finishers', 'factor'])
    };
    const res = await fetch('/api/settings', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      location.reload();
    }
  });

  updateLocked();
});
</script>
{% endblock %}
